@PAYMENT_SERVICE_BASE_URL = http://localhost:3003
@baseUrl = {{PAYMENT_SERVICE_BASE_URL}}/api/payments
@sessionId = zEO9w2-lCy7n
@FEEXPAY_WEBHOOK_SECRET = "test-secret"

# Calculate Feexpay Auth Header (Do this early)
{% client.global.set("FEEXPAY_WEBHOOK_AUTH", Buffer.from(client.global.get("FEEXPAY_WEBHOOK_SECRET") || "").toString("base64")); %}

### 1. Create Payment Intent
# Returns a URL to the custom payment page hosted by this service.
POST {{baseUrl}}/intents
Content-Type: application/json

{
  "userId": "user-http-test-002",
  "subscriptionType": "gold",
  "subscriptionPlan": "yearly",
  "amount": 1000,
  "currency": "XAF"
}

# > {% client.global.set("sessionId", response.body.data.sessionId); %}

### 2. Access Custom Payment Page (Manual Step)
# Copy the paymentPageUrl from the response above and open it in a browser.
# Fill the form and submit it.
# This request below simulates the form submission from the EJS page.

### 3. Submit Payment Details (Simulates EJS form submission)
# Replace {{sessionId}} if not captured from step 1
# Adjust countryCode to test Feexpay ('BJ', 'CI', etc.) or Lygos ('CM', 'GA', etc.)
# Use appropriate TEST phone numbers from gateway docs.
POST {{baseUrl}}/intents/{{sessionId}}/submit
Content-Type: application/json

{
  "paymentCurrency": "XAF",
  "phoneNumber": "237675080477", 
  "countryCode": "CM"
}

### 4. Check Payment Status
# Useful for checking status, especially after Lygos payment attempt.
# Replace {{sessionId}} if not captured from step 1
GET {{baseUrl}}/intents/{{sessionId}}/status


### 5. Simulate Feexpay Webhook (Requires Running Service + Tunnel like ngrok)
# Assumes your payment-service controller verifies the webhook based on 
# FEEXPAY_WEBHOOK_SECRET environment variable matching the 'Header Value' 
# configured in Feexpay dashboard with 'Basic' Header Type.
#
# Replace YOUR_NGROK_URL with your actual ngrok forwarding URL if needed.
# @webhookUrl = https://YOUR_NGROK_URL/api/payments/webhooks/feexpay
@webhookUrl = http://localhost:3003/api/payments/webhooks/feexpay 

POST {{webhookUrl}}
Content-Type: application/json
# You might need to manually add an Authorization header here *if* Feexpay
# doesn't send one automatically or if your controller logic expects it differently.
# Example (if needed): Authorization: Basic BASE64_ENCODED(your_webhook_secret)

{
  "reference": "FEEXPAY_TEST_REF_456",
  "amount": 100,
  "status": "SUCCESSFUL",
  "callback_info": {
    "sessionId": "{{sessionId}}" 
  }
} 