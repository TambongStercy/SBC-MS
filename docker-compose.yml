# Define global environment variables using an extension field
x-env-vars: &common-env-vars
  NODE_ENV: development
  USER_SERVICE_HOST: user-service
  USER_SERVICE_PORT: 3001
  USER_SERVICE_URL: http://user-service:3001
  NOTIFICATION_SERVICE_HOST: notification-service
  NOTIFICATION_SERVICE_PORT: 3002
  NOTIFICATION_SERVICE_URL: http://notification-service:3002
  PAYMENT_SERVICE_HOST: payment-service
  PAYMENT_SERVICE_PORT: 3003
  PAYMENT_SERVICE_URL: http://payment-service:3003
  PRODUCT_SERVICE_HOST: product-service
  PRODUCT_SERVICE_PORT: 3004
  PRODUCT_SERVICE_URL: http://product-service:3004
  ADVERTISING_SERVICE_HOST: advertising-service
  ADVERTISING_SERVICE_PORT: 3005
  ADVERTISING_SERVICE_URL: http://advertising-service:3005
  TOMBOLA_SERVICE_HOST: tombola-service
  TOMBOLA_SERVICE_PORT: 3006
  TOMBOLA_SERVICE_URL: http://tombola-service:3006
  SETTINGS_SERVICE_HOST: settings-service
  SETTINGS_SERVICE_PORT: 3007
  SETTINGS_SERVICE_URL: http://settings-service:3007
  CHAT_SERVICE_HOST: chat-service
  CHAT_SERVICE_PORT: 3008
  CHAT_SERVICE_URL: http://chat-service:3008
  ADMIN_FRONTEND_MS_HOST: admin-frontend-ms
  ADMIN_FRONTEND_MS_PORT: 80
  ADMIN_FRONTEND_MS_URL: http://admin-frontend-ms:80
  API_GATEWAY_URL: http://localhost:3000
  JWT_SECRET: sbc$$jwt$$secret
  GLOBAL_MONGO_BASE_URI: "mongodb://host.docker.internal:27017"

# Define common restart policy and healthcheck for Node.js services
x-node-service-defaults: &node-service-defaults
  restart: unless-stopped
  extra_hosts:
    - "host.docker.internal:host-gateway"

services:
  gateway-service:
    <<: *node-service-defaults
    build:
      context: ./gateway-service
      target: production
    container_name: gateway_service
    command: npm run start
    env_file:
      - ./gateway-service/.env
    environment:
      <<: *common-env-vars
      PORT: 3000
    ports:
      - "3000:3000"
    depends_on:
      - user-service
      - payment-service
      - product-service
      - tombola-service
      - settings-service
      - notification-service
      - chat-service

  user-service:
    <<: *node-service-defaults
    build:
      context: ./user-service
      target: production
    container_name: user_service
    command: npm run start
    env_file:
      - ./user-service/.env
    environment:
      <<: *common-env-vars
      PORT: 3001
      MONGODB_URI_DEV: mongodb://host.docker.internal:27017/sbc_user_dev
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:3001/api/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    volumes:
      - ./user-service:/usr/src/app
      - /usr/src/app/node_modules
    working_dir: /usr/src/app
    ports:
      - "3001:3001"

  payment-service:
    <<: *node-service-defaults
    build:
      context: ./payment-service
      target: production
    container_name: payment_service
    command: npm run start
    env_file:
      - ./payment-service/.env
    environment:
      <<: *common-env-vars
      PORT: 3003
      MONGODB_URI_DEV: mongodb://host.docker.internal:27017/sbc_payment_dev
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:3003/api/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    volumes:
      - ./payment-service:/usr/src/app
      - /usr/src/app/node_modules
    working_dir: /usr/src/app
    ports:
      - "3003:3003"

  product-service:
    <<: *node-service-defaults
    build:
      context: ./product-service
      target: production
    container_name: product_service
    command: npm run start
    env_file:
      - ./product-service/.env
    environment:
      <<: *common-env-vars
      PORT: 3004
      MONGODB_URI_DEV: mongodb://host.docker.internal:27017/sbc_product_dev
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:3004/api/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    volumes:
      - ./product-service:/usr/src/app
      - /usr/src/app/node_modules
    working_dir: /usr/src/app
    ports:
      - "3004:3004"

  tombola-service:
    <<: *node-service-defaults
    build:
      context: ./tombola-service
      target: production
    container_name: tombola_service
    command: npm run start
    env_file:
      - ./tombola-service/.env
    environment:
      <<: *common-env-vars
      PORT: 3006
      MONGODB_URI_DEV: mongodb://host.docker.internal:27017/sbc_tombola_dev
      MAX_TICKETS_PER_USER_PER_MONTH: 25
      CHALLENGE_VOTE_PRICE: 200
      MAX_ENTREPRENEURS_PER_CHALLENGE: 3
      VIDEO_MAX_DURATION_SECONDS: 90
      LOTTERY_POOL_ACCOUNT_ID: ""
      SBC_COMMISSION_ACCOUNT_ID: ""
      SELF_BASE_URL: http://tombola-service:3006
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:3006/api/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    volumes:
      - ./tombola-service:/usr/src/app
      - /usr/src/app/node_modules
    working_dir: /usr/src/app
    ports:
      - "3006:3006"

  settings-service:
    <<: *node-service-defaults
    build:
      context: ./settings-service
      target: production
    container_name: settings_service
    command: npm run start
    env_file:
      - ./settings-service/.env
    environment:
      <<: *common-env-vars
      PORT: 3007
      MONGODB_URI_DEV: mongodb://host.docker.internal:27017/sbc_settings_dev
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:3007/api/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    volumes:
      - ./settings-service:/usr/src/app
      - /usr/src/app/node_modules
    working_dir: /usr/src/app
    ports:
      - "3007:3007"

  notification-service:
    <<: *node-service-defaults
    build:
      context: ./notification-service
      target: production
    container_name: notification_service
    command: npm run start
    env_file:
      - ./notification-service/.env
    environment:
      <<: *common-env-vars
      PORT: 3002
      MONGODB_URI_DEV: mongodb://host.docker.internal:27017/sbc_notification_dev
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_DB: 0
      WHATSAPP_ENABLE_CLOUD_API: "true"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:3002/api/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    volumes:
      - ./notification-service:/usr/src/app
      - /usr/src/app/node_modules
    working_dir: /usr/src/app
    ports:
      - "3002:3002"
    depends_on:
      - redis

  chat-service:
    <<: *node-service-defaults
    build:
      context: ./chat-service
      target: production
    container_name: chat_service
    command: npm run start
    env_file:
      - ./chat-service/.env
    environment:
      <<: *common-env-vars
      PORT: 3008
      MONGODB_URI_DEV: mongodb://host.docker.internal:27017/sbc_chat_dev
      SELF_BASE_URL: http://chat-service:3008
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_DB: 1
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:3008/api/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    volumes:
      - ./chat-service:/usr/src/app
      - /usr/src/app/node_modules
    working_dir: /usr/src/app
    ports:
      - "3008:3008"
    depends_on:
      - redis

  admin-frontend-ms:
    restart: unless-stopped
    build:
      context: ./admin-frontend-ms
    container_name: admin_frontend
    env_file:
      - ./admin-frontend-ms/.env
    environment:
      <<: *common-env-vars
    volumes:
      - ./admin-frontend-ms:/usr/src/app:ro
    ports:
      - "3030:80"

  redis:
    image: redis:7-alpine
    container_name: sbc_redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  app-network:
    driver: bridge

volumes:
  redis-data:
    driver: local